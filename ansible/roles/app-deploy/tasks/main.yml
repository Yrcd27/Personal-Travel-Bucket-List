---
# Application Deployment Role - CI/CD Pipeline Version
# Deploys Travel Bucket List application using Docker Hub images

- name: Create application directory
  file:
    path: "{{ app_dir }}"
    state: directory
    owner: "{{ app_user }}"
    group: "{{ app_user }}"
    mode: '0755'

- name: Generate docker-compose.yml from template
  template:
    src: docker-compose.yml.j2
    dest: "{{ app_dir }}/docker-compose.yml"
    owner: "{{ app_user }}"
    group: "{{ app_user }}"
    mode: '0644'

- name: Pull latest Docker images from Docker Hub
  shell: docker compose pull
  args:
    chdir: "{{ app_dir }}"
  become: true
  become_user: "{{ app_user }}"

- name: Stop and remove existing containers
  shell: docker compose down
  args:
    chdir: "{{ app_dir }}"
  become: true
  become_user: "{{ app_user }}"
  ignore_errors: true

- name: Start application with latest images
  shell: docker compose up -d --force-recreate
  args:
    chdir: "{{ app_dir }}"
  become: true
  become_user: "{{ app_user }}"
  register: compose_output

- name: Wait for frontend to be ready
  wait_for:
    host: localhost
    port: "{{ frontend_port }}"
    delay: 10
    timeout: 60
    state: started

- name: Wait for backend to be ready
  wait_for:
    host: localhost
    port: "{{ backend_port }}"
    delay: 10
    timeout: 60
    state: started

- name: Display running containers
  command: docker ps
  register: docker_ps
  changed_when: false

- name: Show deployment status
  debug:
    msg: 
      - "=== Deployment Complete ==="
      - "Frontend: http://{{ ansible_host }}:{{ frontend_port }}"
      - "Backend: http://{{ ansible_host }}:{{ backend_port }}"
      - "Running Containers:"
      - "{{ docker_ps.stdout_lines }}"
